os: linux
dist: bionic

addons:
  apt:
    sources:
      - sourceline: 'deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main'
        key_url: 'https://dl.google.com/linux/linux_signing_key.pub'
    packages:
      - google-chrome-stable

services:
  - docker
  - xvfb

language: node_js

node_js:
  - "10"

script:
  - npm run lint
  - npm run test:cover
  - npm run build:docker
  - npm run e2e

after_success:
  - npm run coveralls
  - bash <(curl -Ls https://coverage.codacy.com/get.sh) report -l TypeScript -r ./coverage/lcov.info

before_deploy: ./bin/prepare-deploy.sh

deploy:
  - provider: cloudfoundry
    skip_cleanup: true
    api: https://api.run.pcfone.io
    username: $CF_USERNAME
    password: $CF_PASSWORD
    organization: pivot-jsharpe
    space: development
    on:
      tags: true
  - provider: releases
    skip_cleanup: true
    api_key: $GITHUB_TOKEN
    name: ${TRAVIS_TAG}
    file: dist-${TRAVIS_TAG}.tar.gz
    on:
      tags: true
  - provider: script
    skip_cleanup: true
    script: ./bin/deploy-docker.sh
    on:
      tags: true
  - provider: pages
    skip_cleanup: true
    github_token: $GITHUB_TOKEN
    keep_history: true
    target_branch: gh-pages
    local_dir: dist-ghp/
    on:
      tags: true
